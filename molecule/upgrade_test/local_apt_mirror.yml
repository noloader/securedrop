---
- name: Update cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Copy over certs
  copy:
    src: "{{ item.s }}"
    dest: "{{ item.d }}"
  with_items:
    - s: apt_https.pub
      d: /etc/ssl/certs/apt_freedom_press.pem
    - s: apt_https.priv
      d: /etc/ssl/private/apt_freedom_press.priv

- include_role:
    name: jdauphant.nginx

- name: Install server dependencies
  apt:
    name: reprepro

- name: Make directories
  file:
    state: directory
    path: "/var/repos/{{ item }}"
  with_items:
    - base
    - conf
    - debs

- name: Copy over apt priv key
  copy:
    dest: /tmp/apt-test.priv
    src: apt-test.priv

- name: Import apt-test key
  command: gpg --import /tmp/apt-test.priv
  ignore_errors: yes

- name: Copy over debs
  synchronize:
    src: "{{ molecule_dir }}/../../build/"
    dest: /var/repos/debs/
    delete: yes

- name: Establish config
  template:
    src: "distributions.j2"
    dest: "/var/repos/conf/distributions"

- name: Run reprepo
  shell: |
    find {{dpkg_dir}} -type f -name '*.deb' -exec reprepro includedeb "{{rep_dist}}" '{}' \;
  environment:
    REPO_DIR: /var/repos
    REPREPRO_CONFIG_DIR: /var/repos/conf
    REPREPRO_BASE_DIR: /var/repos/base

- name: Delete existing signature
  file:
    state: absent
    path: "{{ release_file }}.gpg"
  changed_when: false

- name: Sign release file
  command:  "gpg -b -u C5D5CD3B6D65484B -o {{ release_file }}.gpg {{ release_file }}"
  changed_when: false

- name: Copy pub key in-place
  copy:
    src: apt-test.pub
    dest: /var/repos/base/apt-test.pub
